<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <!-- kakao map scripts -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ee82098d00c66ccb2a3a065f048a3134"></script>

    <!-- import roslijs scripts : for using ROS -->
    <script src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  </head>

  <body>
    <h1>ROS to Web [Local 환경]</h1>
    <p>
      ROS_bridge Connection Status :
      <span style="font-size: x-large; color: magenta" id="status"></span>
    </p>

    <br />
    <hr />
    <h2>topic : /Ego_status</h2>
    <br />
    <p>Accel (%): <span id="accel"></span></p>
    <p>Brake (%): <span id="brake"></span></p>
    <p>position.x (utm): <span id="position.x"></span></p>
    <p>position.y (utm): <span id="position.y"></span></p>
    <p>velocity (km/h): <span id="velocity.x"></span></p>

    <br />
    <hr />
    <h2>topic : /gps</h2>
    <br />
    <p>altitude (고도) : <span id="GPS_altitude"></span></p>
    <p>latitude (위도) : <span id="GPS_latitude"></span></p>
    <p>longitude (경도) : <span id="GPS_longitude"></span></p>

    <br />
    <hr />
    <h2>topic : /imu</h2>
    <br />
    <h5>3축에 대한 선형 가속도</h5>
    <p>linear_acceleration_x : <span id="linear_acceleration_x"></span></p>
    <p>linear_acceleration_y : <span id="linear_acceleration_y"></span></p>
    <p>linear_acceleration_z : <span id="linear_acceleration_z"></span></p>
    <br />
    <h5>Quaternion 벡터(x,y,z) 스칼라(w)</h5>
    <p>vector_x : <span id="vector_x"></span></p>
    <p>vector_y : <span id="vector_y"></span></p>
    <p>vector_z : <span id="vector_z"></span></p>
    <p>scalar_w : <span id="scalar_w"></span></p>

    <br />
    <hr />
    <h2>map</h2>
    <div id="map" style="width: 750px; height: 350px"></div>
    <button onclick="sendPath()">택시호출</button>

    <br />
    <hr />
    <h2>topic : /image_jpeg/compressed</h2>
    <img width="500" height="400" id="image" />

    <script>
      // connect to ROS_bridge_server (local websocket)
      var ros = new ROSLIB.Ros({
              url : 'ws://192.168.56.101:9090'
      });
      // check ROS_bridge Connection Status
      ros.on('connection', function() {
          document.getElementById("status").innerHTML = "Connected";
      });
      ros.on('error', function(error) {
          document.getElementById("status").innerHTML = "Error";
      });
      ros.on('close', function() {
          document.getElementById("status").innerHTML = "Closed";
      });


      // -------------------------------------------- Ego status --------------------------------------------
      // get Ego status data from topic : /Ego_topic
      var Ego_topic_listener = new ROSLIB.Topic({
              ros : ros,
              name : '/Ego_topic',
              messageType : 'morai_msgs/EgoVehicleStatus'
          });

      // activate like callback_function
      Ego_topic_listener.subscribe(function(data) {
          document.getElementById("accel").innerHTML = data.accel * 100;  // to express as a percentage (%)
          document.getElementById("brake").innerHTML = data.brake * 100;  // to express as a percentage (%)
          document.getElementById("position.x").innerHTML = data.position.x; // utm_x
          document.getElementById("position.y").innerHTML = data.position.y; // utm_y

          var velocity = data.velocity.x;
          if (velocity < 0) {
              velocity = 0
          }
          // parseInt : discard decimal places (only show int)
          document.getElementById("velocity.x").innerHTML = parseInt(velocity * 3.6); //  m/s  >>  km/h
      })


      // -------------------------------------------- GPS Sensor --------------------------------------------
      // get GPS data from topic : /gps
      var GPS_topic_listener = new ROSLIB.Topic({
          ros : ros,
          name : '/gps',
          messageType : 'morai_msgs/GPSMessage'
      })

      var latitude;
      var longitude;

      GPS_topic_listener.subscribe(function(data) {
          latitude = data.latitude
          longitude = data.longitude
          document.getElementById("GPS_altitude").innerHTML = data.altitude
          document.getElementById("GPS_latitude").innerHTML = data.latitude
          document.getElementById("GPS_longitude").innerHTML = data.longitude
      })


      // -------------------------------------------- IMU Sensor --------------------------------------------
      // get IMU data from topic : /imu
      var IMU_topic_listener = new ROSLIB.Topic({
          ros : ros,
          name : '/imu',
          messageType : 'sensor_msgs/Imu'
      })

      IMU_topic_listener.subscribe(function(data) {
          document.getElementById("linear_acceleration_x").innerHTML = data.linear_acceleration.x
          document.getElementById("linear_acceleration_y").innerHTML = data.linear_acceleration.y
          document.getElementById("linear_acceleration_z").innerHTML = data.linear_acceleration.z
          document.getElementById("vector_x").innerHTML = data.orientation.x
          document.getElementById("vector_y").innerHTML = data.orientation.y
          document.getElementById("vector_z").innerHTML = data.orientation.z
          document.getElementById("scalar_w").innerHTML = data.orientation.w
      })


      // -------------------------------------------- Camera Sensor --------------------------------------------
      // get Camera image from topic : /image_jpeg/compressed
      var Camera_listener = new ROSLIB.Topic({
          ros : ros,
          name : '/image_jpeg/compressed',
          messageType : 'sensor_msgs/CompressedImage'
      });

      Camera_listener.subscribe(function(data) {
          document.getElementById('image').src = "data:image/jpeg;base64," + data.data;
      })


      // -------------------------------------------- Map ------------------------------------------------------
      // send gps data to service : /
      var mapContainer = document.getElementById('map'), // 지도를 표시할 div
          mapOption = {
              center: new kakao.maps.LatLng(37.240292239210696, 126.77383454342596), // 지도의 중심좌표
              level: 4, // 지도의 확대 레벨
              mapTypeId : kakao.maps.MapTypeId.ROADMAP // 지도종류
          };
      // 지도를 생성한다
      var map = new kakao.maps.Map(mapContainer, mapOption);

      var startSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png', // 출발 마커이미지의 주소입니다
          startSize = new kakao.maps.Size(50, 45), // 출발 마커이미지의 크기입니다
          startOption = {
              offset: new kakao.maps.Point(15, 43) // 출발 마커이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
          };

      // 출발 마커 이미지를 생성합니다
      var startImage = new kakao.maps.MarkerImage(startSrc, startSize, startOption);

      var startDragSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_drag.png', // 출발 마커의 드래그 이미지 주소입니다
          startDragSize = new kakao.maps.Size(50, 64), // 출발 마커의 드래그 이미지 크기입니다
          startDragOption = {
              offset: new kakao.maps.Point(15, 54) // 출발 마커의 드래그 이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
          };

      // 출발 마커의 드래그 이미지를 생성합니다
      var startDragImage = new kakao.maps.MarkerImage(startDragSrc, startDragSize, startDragOption);

      // 출발 마커가 표시될 위치입니다
      var startPosition = new kakao.maps.LatLng(37.240292239210696, 126.77383454342596);

      // 출발 마커를 생성합니다
      var startMarker = new kakao.maps.Marker({
          map: map, // 출발 마커가 지도 위에 표시되도록 설정합니다
          position: startPosition,
          draggable: true, // 출발 마커가 드래그 가능하도록 설정합니다
          image: startImage // 출발 마커이미지를 설정합니다
      });

      // 출발 마커에 dragstart 이벤트를 등록합니다
      kakao.maps.event.addListener(startMarker, 'dragstart', function() {
          // 출발 마커의 드래그가 시작될 때 마커 이미지를 변경합니다
          startMarker.setImage(startDragImage);
      });

      // 출발 마커에 dragend 이벤트를 등록합니다
      kakao.maps.event.addListener(startMarker, 'dragend', function() {
          // 출발 마커의 드래그가 종료될 때 마커 이미지를 원래 이미지로 변경합니다
          startMarker.setImage(startImage);
      });

      var arriveSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_b.png', // 도착 마커이미지 주소입니다
      arriveSize = new kakao.maps.Size(50, 45), // 도착 마커이미지의 크기입니다
      arriveOption = {
          offset: new kakao.maps.Point(15, 43) // 도착 마커이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
      };

      // 도착 마커 이미지를 생성합니다
      var arriveImage = new kakao.maps.MarkerImage(arriveSrc, arriveSize, arriveOption);

      var arriveDragSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_drag.png', // 도착 마커의 드래그 이미지 주소입니다
          arriveDragSize = new kakao.maps.Size(50, 64), // 도착 마커의 드래그 이미지 크기입니다
          arriveDragOption = {
              offset: new kakao.maps.Point(15, 54) // 도착 마커의 드래그 이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
          };

      // 도착 마커의 드래그 이미지를 생성합니다
      var arriveDragImage = new kakao.maps.MarkerImage(arriveDragSrc, arriveDragSize, arriveDragOption);

      // 도착 마커가 표시될 위치입니다
      var arrivePosition = new kakao.maps.LatLng(37.240292239210696, 126.77383454342596);

      // 도착 마커를 생성합니다
      var arriveMarker = new kakao.maps.Marker({
          map: map, // 도착 마커가 지도 위에 표시되도록 설정합니다
          position: arrivePosition,
          draggable: true, // 도착 마커가 드래그 가능하도록 설정합니다
          image: arriveImage // 도착 마커이미지를 설정합니다
      });

      // 도착 마커에 dragstart 이벤트를 등록합니다
      kakao.maps.event.addListener(arriveMarker, 'dragstart', function() {
          // 도착 마커의 드래그가 시작될 때 마커 이미지를 변경합니다
          arriveMarker.setImage(arriveDragImage);
      });

      // 도착 마커에 dragend 이벤트를 등록합니다
      kakao.maps.event.addListener(arriveMarker, 'dragend', function() {
          // 도착 마커의 드래그가 종료될 때 마커 이미지를 원래 이미지로 변경합니다
          arriveMarker.setImage(arriveImage);
      });

      // Publishing a Topic
      // ------------------
   
      var GPS_start_talker = new ROSLIB.Topic({
        ros : ros,
        name : '/startGPS',
        messageType : 'morai_msgs/GPSMessage'
      });

      var GPS_arrive_talker = new ROSLIB.Topic({
        ros : ros,
        name : '/arriveGPS',
        messageType : 'morai_msgs/GPSMessage'
      });
 
      function sendPath() {
        var startGPS = new ROSLIB.Message({
          latitude : startMarker.getPosition().getLat(),
          longitude : startMarker.getPosition().getLng()
        });

        var arriveGPS = new ROSLIB.Message({
          latitude : arriveMarker.getPosition().getLat(),
          longitude : arriveMarker.getPosition().getLng()
        });

        GPS_start_talker.publish(startGPS);
        GPS_arrive_talker.publish(arriveGPS);
      }
    </script>
  </body>
</html>
